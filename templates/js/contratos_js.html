<script>
    let timeoutBuscarContratoId;
    let clientesData = []; // Armazena os clientes para paginação
    let currentPage = 1;
    const rowsPerPage = 5;

    let planosData = []; // Armazena os planos para paginação
    let currentPlanoPage = 1;
    const planoRowsPerPage = 5;

    function renderClientesPage() {
        const tbody = $('.clientes-table tbody');
        tbody.empty();

        if (!clientesData.length) {
            tbody.html(`
                <tr>
                    <td colspan="6" class="text-center">Nenhum cliente relacionado ao contrato encontrado.</td>
                </tr>
            `);
            $('#pageInfo').text('');
            $('#prevPage, #nextPage').prop('disabled', true);
            return;
        }

        const totalPages = Math.ceil(clientesData.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        clientesData.slice(start, end).forEach(cliente => {
            tbody.append(`
                <tr>
                    <td>${cliente.nome_fantasia || ''}</td>
                    <td>${cliente.razao_social || ''}</td>
                    <td>${cliente.cnpj || ''}</td>
                    <td>${cliente.atividade || ''}</td>
                    <td>${cliente.cidade || ''}</td>
                    <td>
                        <span class="status-badge ${cliente.estado_atual === 'Ativo' ? 'status-ativo' : 'status-inativo'}">
                            ${cliente.estado_atual || 'N/A'}
                        </span>
                    </td>
                </tr>
            `);
        });

        $('#pageInfo').text(`Página ${currentPage} de ${totalPages}`);
        $('#prevPage').prop('disabled', currentPage === 1);
        $('#nextPage').prop('disabled', currentPage === totalPages);
    }

    $('#prevPage').on('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderClientesPage();
        }
    });

    $('#nextPage').on('click', () => {
        if (currentPage < Math.ceil(clientesData.length / rowsPerPage)) {
            currentPage++;
            renderClientesPage();
        }
    });

    // -------- PAGINAÇÃO DE PLANOS --------

    function renderPlanosPage() {
        const tbody = $('.planos-table tbody');
        tbody.empty();

        if (!planosData.length) {
            tbody.html(`
                <tr>
                    <td colspan="5" class="text-center">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Nenhum plano associado encontrado
                    </td>
                </tr>
            `);
            $('#planos-pageInfo').text('');
            $('#planos-prevPage, #planos-nextPage').prop('disabled', true);
            return;
        }

        const totalPages = Math.ceil(planosData.length / planoRowsPerPage);
        const start = (currentPlanoPage - 1) * planoRowsPerPage;
        const end = start + planoRowsPerPage;

        planosData.slice(start, end).forEach(plano => {
            tbody.append(`
                <tr>
                    <td>${plano.id}</td>
                    <td>${plano.codigo}</td>
                    <td>${plano.nome}</td>
                    <td>R$ ${plano.valor.toFixed(2)}</td>
                    <td>
                        <span class="badge ${plano.status === 'Ativo' ? 'bg-success' : 'bg-danger'}">
                            ${plano.status}
                        </span>
                    </td>
                </tr>
            `);
        });

        $('#planos-pageInfo').text(`Página ${currentPlanoPage} de ${totalPages}`);
        $('#planos-prevPage').prop('disabled', currentPlanoPage === 1);
        $('#planos-nextPage').prop('disabled', currentPlanoPage === totalPages);
    }

    $('#planos-prevPage').on('click', () => {
        if (currentPlanoPage > 1) {
            currentPlanoPage--;
            renderPlanosPage();
        }
    });

    $('#planos-nextPage').on('click', () => {
        if (currentPlanoPage < Math.ceil(planosData.length / planoRowsPerPage)) {
            currentPlanoPage++;
            renderPlanosPage();
        }
    });

    // -------- BUSCA DE CONTRATO --------

    function buscarDadosContrato(numeroContrato) {
        if (!numeroContrato) return;

        $('#loadingContrato').removeClass('d-none');
        clearTimeout(timeoutBuscarContratoId);

        timeoutBuscarContratoId = setTimeout(() => {
            $.ajax({
                url: '/contratos/buscar-por-numero/' + numeroContrato,
                method: 'GET',
                success: function(data) {
                    console.log("Dados recebidos:", data);

                    if (!data.cliente) {
                        console.warn("Cliente não encontrado na resposta.");
                    }

                    const fieldMap = {
                        'numero': '#numeroContrato',
                        'razao_social': '#razao_social',
                        'nome_fantasia': '#nome_fantasia',
                        'atualizacao': '#atualizacao',
                        'cadastramento': '#cadastramento',
                        'tipo': '#tipo',
                        'contato': '#contato',
                        'id_matriz_portal': '#id_matriz_portal',
                        'email': '#email',
                        'telefone': '#telefone',
                        'responsavel': '#responsavel',
                        'code_residence': '#code_residence',
                        'cnpj': '#cnpj',
                        'revenda': '#revenda',
                        'vendedor': '#vendedor',
                        'endereco': '#endereco',
                        'complemento': '#complemento',
                        'bairro': '#bairro',
                        'cidade': '#cidade',
                        'estado': '#estado',
                        'dia_vencimento': '#dia_vencimento',
                        'fator_juros': '#fator_juros',
                        'estado_contrato': '#estado_contrato',
                        'data_estado': '#data_estado',
                        'motivo_estado': '#motivo_estado',
                        'plano_nome': '#plano_nome',
                        'valor_plano': '#valor_plano',
                        'valor_contrato': '#valor_contrato'
                    };

                    Object.values(fieldMap).forEach(selector => {
                        const element = $(selector);
                        if (element.length) {
                            if (element.is('input[type="checkbox"]')) {
                                element.prop('checked', false);
                            } else {
                                element.val('').trigger('change');
                            }
                        }
                    });

                    Object.keys(fieldMap).forEach(key => {
                        const value = data[key];
                        const selector = fieldMap[key];
                        const element = $(selector);

                        if (!element.length) {
                            console.warn(`Elemento ${selector} não encontrado.`);
                            return;
                        }

                        if (key === 'estado_contrato') {
                            element.val(value || '')
                                .removeClass('status-ativo status-inativo')
                                .addClass(value ? 'status-' + value.toLowerCase() : '');
                        } else {
                            element.val(value || '');
                        }
                    });

                    // Atualiza a TABELA DE CLIENTES com paginação
                    if (data.clientes && Array.isArray(data.clientes)) {
                        clientesData = data.clientes;
                        currentPage = 1;
                        renderClientesPage();
                    } else {
                        clientesData = [];
                        renderClientesPage();
                    }

                    // Atualiza a TABELA DE PLANOS com paginação
                    if (data.planos && Array.isArray(data.planos)) {
                        planosData = data.planos;
                        currentPlanoPage = 1;
                        renderPlanosPage();
                    } else {
                        planosData = [];
                        renderPlanosPage();
                    }

                    // Atualiza a TABELA DE PRODUTOS
                    if (data.produtos && Array.isArray(data.produtos)) {
                        const linhasProdutos = data.produtos.map(produto => `
                            <tr>
                                <td>${produto.id || ''}</td>
                                <td>${produto.nome || ''}</td>
                                <td>${produto.descricao || 'N/A'}</td>
                                <td>${produto.quantidade || 0}</td>
                                <td>R$ ${produto.valor_unitario ? produto.valor_unitario.toFixed(2) : '0.00'}</td>
                            </tr>
                        `).join('');
                        $('.produtos-table tbody').html(linhasProdutos);
                    } else {
                        $('.produtos-table tbody').html(`
                            <tr>
                                <td colspan="5" class="text-center">
                                    <i class="bi bi-exclamation-circle me-2"></i>
                                    Nenhum produto associado encontrado
                                </td>
                            </tr>
                        `);
                    }

                    // ======= SOMA DOS VALORES DE PLANOS E PRODUTOS =======
                    let totalPlanos = 0;
                    if (data.planos && Array.isArray(data.planos)) {
                        totalPlanos = data.planos.reduce((acc, plano) => acc + (plano.valor || 0), 0);
                    }

                    let totalProdutos = 0;
                    if (data.produtos && Array.isArray(data.produtos)) {
                        totalProdutos = data.produtos.reduce((acc, produto) => {
                            const quantidade = produto.quantidade || 0;
                            const valorUnitario = produto.valor_unitario || 0;
                            return acc + (quantidade * valorUnitario);
                        }, 0);
                    }

                    const valorTotalContrato = totalPlanos + totalProdutos;

                    // Atualiza o campo #valor_contrato com o valor total
                    $('#valor_contrato').val(valorTotalContrato.toFixed(2));
                },
                error: function(xhr) {
                    console.error("Erro na requisição:", xhr);
                    alert('Não foi possível localizar o contrato. Confirme se o número informado está correto e se você está no ambiente certo.'
);
                },
                complete: function() {
                    console.log("Requisição finalizada.");
                    $('#loadingContrato').addClass('d-none');
                }
            });
        }, 500);
    }

    // -------- CAPTURA DO ENTER OU BLUR NO CAMPO --------
    document.addEventListener("DOMContentLoaded", function () {
        const numeroContratoInput = document.getElementById("numeroContrato");
        if (numeroContratoInput) {
            // Enter
            numeroContratoInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault(); // impede submit do form
                    buscarDadosContrato(this.value);
                }
            });

            // Blur (quando perde o foco)
            numeroContratoInput.addEventListener("change", function () {
                buscarDadosContrato(this.value);
            });
        }
    });
</script>



<script>
    let timeoutId;
    function buscarContrato(termo) {
        if (!termo) return;
        $('#loadingContrato').removeClass('d-none');
        clearTimeout(timeoutId);

        timeoutId = setTimeout(() => {
            $.ajax({
                url: '/buscar_contrato',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ termo: termo }),
                success: function(data) {
                    console.log("Dados recebidos:", data);
                    if (data.success) {
                        const contrato = data.contrato;
                        const fieldMap = {
                            'numero': '#contract_number',
                            'razao_social': '#company_name',
                            //'registration': '#registration',
                            'nome_fantasia': '#trade_name',
                            //'atualizacao': '#update',
                            'tipo': '#type',
                            'contato': '#contact',
                            'id_matriz_portal': '#id_matriz_portal',
                            'address_email': '#address_email',
                            'telefone': '#phone',
                            'responsavel': '#responsible',
                            'zip_code_cep': '#zip_code_cep',
                            'cnpj_cpf': '#cnpj_cpf',
                            'endereco': '#address',
                            'complemento': '#complement',
                            'bairro': '#neighborhood',
                            'cidade': '#city',
                            'estado': '#state',
                            'fator_juros': '#interest_rate_factor',
                            'dia_vencimento': '#last_day',
                            'estado_contrato': '#current_state',
                            'data_estado': '#state_date',
                            'motivo_estado': '#reason',
                            'estado_contrato': '#current_state',
                        };

                        for (const key in fieldMap) {
                            if (contrato[key] !== null && contrato[key] !== undefined) {
                                const val = (key.includes('data')) ? formatarData(contrato[key]) : contrato[key];
                                $(fieldMap[key]).val(val);
                            }
                        }
                    } else {
                        alert('Contrato não encontrado!');
                    }
                    $('#loadingContrato').addClass('d-none');
                },
                error: function(xhr, status, error) {
                    console.error("Erro:", status, error);
                    alert('Erro ao buscar contrato.');
                    $('#loadingContrato').addClass('d-none');
                }
            });
        }, 1000);
    }
    function formatarData(data) {
        const d = new Date(data);
        return !isNaN(d) ? `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}` : '';
    }

    $('#search_contract').on('input', function() {
        buscarContrato($(this).val());
    });
</script>


  